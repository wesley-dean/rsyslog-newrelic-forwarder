## Template expected by the New Relic Syslog endpoint

template(name="NRLogFormat" type="string" string="{{ newrelic_account_id }} <%pri%>%protocol-version% %timestamp:::date-rfc3339% %hostname% %app-name% %procid% %msgid% %structured-data% %msg%\n")


module(load="imfile" PollingInterval="10")

input(type="imfile" File="/var/log/messages" Tag="syslog")

## Configure TLS and log forwarding
global(DefaultNetstreamDriver="gtls"
       DefaultNetstreamDriverCAFile="/etc/ssl/cert.pem"
)

#*.* @@newrelic.syslog.nr-data.net:6514;NRLogFormat
#
action(type="omfwd"
  target="newrelic.syslog.nr-data.net"
  port="6514"
  protocol="tcp"
  template="NRLogFormat"
  ResendLastMSGOnReconnect="on"
  StreamDriver="gtls"
  StreamDriverAuthMode="x509/name"
  StreamDriverPermittedPeers="*.syslog.nr-data.net"
  StreamDriverMode="1"
)
